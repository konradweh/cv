% ============================================================
% PREAMBLE.TEX
% All non-content: packages, fonts, colors, layout, macros
% (Cleaned up: same functionality, clearer structure & comments)
% ============================================================

% -----------------------------
% Language / Localization
% -----------------------------
\usepackage[german]{babel}

% -----------------------------
% Page layout & basic tools
% -----------------------------
\usepackage[a4paper,top=10mm,bottom=10mm,left=10mm,right=10mm]{geometry}
\usepackage{graphicx}
\usepackage{calc}
\usepackage{array}
\usepackage{tabularx}
\usepackage[hidelinks]{hyperref}

% Two-column content
\usepackage{paracol}

% Drawing / background overlay (header bar, photo, separation line)
\usepackage{tikz}
\usepackage{eso-pic}
\usepackage{tikzpagenodes}

% -----------------------------
% Colors
% -----------------------------
\usepackage{xcolor}
\definecolor{cvlightblue}{HTML}{D6DCE4}
\definecolor{cvblue}{HTML}{8F9AAD}
\definecolor{cvblack}{HTML}{000000}
\colorlet{cvgray}{black!65}
\colorlet{cvlightgray}{black!10}

% -----------------------------
% Fonts (XeLaTeX / LuaLaTeX)
% -----------------------------
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}

% Body font
\setmainfont{Calibri}
\setsansfont{Calibri}

% Headline font
\newfontfamily\CalibriLight{Calibri Light}

\usepackage{setspace}
\setstretch{0.9}

% -----------------------------
% Typography helpers
% -----------------------------
\usepackage{microtype}
\usepackage{lipsum}

% -----------------------------
% Global paragraph settings
% NOTE: Inside some macros we locally override parskip/parindent to keep spacing stable.
% -----------------------------
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt}

% ============================================================
% Layout dimensions (header, photo, columns)
% ============================================================

% Header height
\newlength{\HeaderH}
\setlength{\HeaderH}{35mm}

% Photo dimensions and vertical offset
\newlength{\PhotoW} \setlength{\PhotoW}{35mm}
\newlength{\PhotoH} \setlength{\PhotoH}{45mm}
\newlength{\PhotoOffset}
\setlength{\PhotoOffset}{-7mm}

% Column separation and ratio
\newlength{\ColSep}
\setlength{\ColSep}{12mm}

\newcommand{\LeftColRatio}{0.35} % <-- adjust left/right column ratio here

% Derived column helper lengths
\newlength{\ContentW}
\newlength{\LeftColW}

\setlength{\ContentW}{\textwidth}
\addtolength{\ContentW}{-\ColSep}

\setlength{\LeftColW}{\LeftColRatio\ContentW}

% x-position of the vertical separator line between columns
\newlength{\SepLineX}
\setlength{\SepLineX}{\LeftColW}
\addtolength{\SepLineX}{0.5\ColSep}

% ============================================================
% Headings and header typography
% ============================================================

% Section heading (uppercase + letter spacing)
\newcommand{\cvsection}[1]{%
  \par
  {\CalibriLight
   \fontsize{11}{14}\selectfont
   \color{cvblack}
   \addfontfeatures{LetterSpace=25}
   \spaceskip=1em
   \MakeUppercase{#1}\par}%
  \vspace{1pt}%
}

\newcommand{\cvsubsection}[1]{%
  \par\vspace*{2pt}
  {\CalibriLight
   \fontsize{9}{12}\selectfont
   \color{cvblack}
   \addfontfeatures{LetterSpace=15}
   \spaceskip=0.5em
   \MakeUppercase{#1}\par}%
  \vspace{6pt}%
}

% First name in header
\newcommand{\cvfirstname}[1]{%
  {\CalibriLight
   \fontsize{27}{32}\selectfont
   \color{cvgray}
   \addfontfeatures{LetterSpace=25}%
   \spaceskip=1em
   \MakeUppercase{#1}}%
}

% Last name in header
\newcommand{\cvlastname}[1]{%
  {\CalibriLight
   \fontsize{27}{32}\selectfont
   \color{cvblack}
   \addfontfeatures{LetterSpace=25}%
   \spaceskip=1em
   \MakeUppercase{#1}}%
}

% "Curriculum Vitae" label in header
\newcommand{\cvcv}[1]{%
  {\CalibriLight
   \fontsize{20}{24}\selectfont
   \color{cvgray}
   \addfontfeatures{LetterSpace=25}%
   \spaceskip=1em
   \MakeUppercase{#1}}%
}

% ============================================================
% Language skill bars
% ============================================================

% --- Styling knobs (easy to tweak) ---
\newlength{\LangBarDashW} \setlength{\LangBarDashW}{7mm}     % width of one dash
\newlength{\LangBarDashH} \setlength{\LangBarDashH}{0.8mm}   % height of one dash
\newlength{\LangBarGap}   \setlength{\LangBarGap}{2mm}       % gap between dashes
\newlength{\LangBarTotalW}                                     % computed total width

\newlength{\LangGapTop} \setlength{\LangGapTop}{8pt}         % space: title -> bar
\newlength{\LangGapBot} \setlength{\LangGapBot}{8pt}         % space: bar -> description

\colorlet{cvbaron}{cvblue}        % "filled" dash color
\colorlet{cvbaroff}{cvlightgray}  % "empty" dash color

% Draw N dashes, first K are "filled"
\newcommand{\cvlangbar}[2]{%
  \begin{tikzpicture}[baseline=(current bounding box.south)]
    \foreach \i in {1,...,#2} {%
      \pgfmathsetlengthmacro{\x}{(\i-1)*(\LangBarDashW+\LangBarGap)}%
      \ifnum\i>#1
        \fill[cvbaroff] (\x,0) rectangle ++(\LangBarDashW,\LangBarDashH);
      \else
        \fill[cvbaron]  (\x,0) rectangle ++(\LangBarDashW,\LangBarDashH);
      \fi
    }%
  \end{tikzpicture}%
}

% One language entry:
% #1 label (e.g. German:)
% #2 level (e.g. C2)
% #3 filled dashes
% #4 total dashes
% #5 description (e.g. native speaker)
\newcommand{\cvlanguage}[5]{%
  \par\addvspace{10pt}%

  \begingroup
    \setlength{\parskip}{0pt}%

    \setlength{\LangBarTotalW}{%
      \dimexpr #4\LangBarDashW + \numexpr#4-1\relax\LangBarGap \relax
    }%

    \noindent
    \vbox{\offinterlineskip
      % line 1: label + description + CEFR level (all in one line)
      \hbox to \LangBarTotalW{%
        \textbf{#1}\hfil
        \hfil#5
        \textbf{#2}%
      }%
      \kern\LangGapTop

      % line 2: bar
      \hbox{\cvlangbar{#3}{#4}}%
    }%
  \endgroup
  \par
}


% ============================================================
% CV entries with right-aligned date (vertically centered)
% ============================================================

\newlength{\CVDateW}
\setlength{\CVDateW}{35mm} % width reserved for the date column (right side)

\newsavebox{\CVLeftBox}
\newlength{\CVLeftW}
\newlength{\CVLeftHT}

\newlength{\CVEntryGap}
\setlength{\CVEntryGap}{10pt} % constant space AFTER each entry

% #1 = title (bold)
% #2 = body (can contain controlled line breaks, e.g. \cvline)
% #3 = date (right column)
\newcommand{\cventry}[3]{%
  \begingroup
    \setlength{\parskip}{0pt}%
    \setlength{\parindent}{0pt}%

    \setlength{\CVLeftW}{\dimexpr\linewidth-\CVDateW\relax}%

    % Left content is boxed to measure its height; date box uses the same height,
    % so the date is vertically centered next to the text block.
    \sbox{\CVLeftBox}{%
      \begin{minipage}[t]{\CVLeftW}%
        \raggedright
        \begin{tabularx}{\linewidth}{@{}X@{}}
          \textbf{#1}\par
          #2
        \end{tabularx}%
      \end{minipage}%
    }%

    \setlength{\CVLeftHT}{\dimexpr\ht\CVLeftBox+\dp\CVLeftBox\relax}%

    \noindent
    \usebox{\CVLeftBox}%
    \hfill
    \begin{minipage}[c][\CVLeftHT][c]{\CVDateW}%
      \raggedleft{\color{cvblue}\small #3}%
    \end{minipage}%
    \par\vspace{\CVEntryGap}%
  \endgroup
}

\newcommand{\cvitem}[1]{%
  \par\noindent #1%
  \par\vspace*{1mm}
}

\newcommand{\cvlastitem}[1]{%
  \par\noindent #1%
}


% ============================================================
% Header background, photo & vertical separator line
% ============================================================

\AddToShipoutPictureBG{%
\begin{tikzpicture}[remember picture,overlay]
  % Header vertical center reference
  \coordinate (HeaderCenterY) at ([yshift=-0.5\HeaderH]current page.north west);

  % Header background bar
  \fill[cvlightblue]
    (current page.north west) rectangle
    ([yshift=-\HeaderH]current page.north east);

  % Photo block (vertically centered in header)
  \coordinate (PhotoC) at ([xshift=-10mm-0.5\PhotoW]HeaderCenterY -| current page.north east);
  \node[anchor=center] at (PhotoC) {%
    \begin{tikzpicture}
      \node (img) {\includegraphics[
        width=0.95\PhotoW,
        height=0.95\PhotoH,
        keepaspectratio
      ]{portrait_circle.png}};
      \draw[line width=0.8pt, color=cvblue] (img.center) circle[radius=0.475\PhotoW];
    \end{tikzpicture}%
  };

  % Vertical separation line between left and right content areas
  \draw[cvblue, line width=0.8pt]
    ([xshift=10mm+\SepLineX, yshift=-\HeaderH]current page.north west) --
    ([xshift=10mm+\SepLineX, yshift=10mm]current page.south west);

\end{tikzpicture}%
}

% Horizontal section separator (blue stripe)
\newcommand{\cvhstripe}{%
  \par\vspace{5pt}%
  \noindent{\color{cvblue}\rule{\linewidth}{0.8pt}}%
  \par\vspace{5pt}%
}

% ============================================================
% Body start offset (push content below header bar / photo overlap)
% ============================================================

\newlength{\BodyStart}
\setlength{\BodyStart}{\HeaderH}
\addtolength{\BodyStart}{-15mm}

% ============================================================
% Header text placement helper
% ============================================================

% Places the name + title text inside the header bar (right column zone)
\newcommand{\PlaceHeaderText}[3]{%
  \begin{tikzpicture}[remember picture,overlay]
    % vertical center of the header bar
    \coordinate (HeaderCenterY) at ([yshift=-0.5\HeaderH]current page.north west);

    \node[anchor=west, align=left] at ([xshift=10mm]HeaderCenterY) {%
      \cvfirstname{#1}\hspace{1.5em}\cvlastname{#2}\\[10pt]
      \cvcv{#3}%
    };
  \end{tikzpicture}%
}

% ============================================================
% Signature (place at end of document)
% ============================================================

% #1 = Location, #2 = Date
\newcommand{\cvsignature}[2]{%
  \vspace{3\baselineskip}

  \noindent
  \begin{minipage}[t]{0.45\linewidth}
    #1, #2
  \end{minipage}%
  \hfill
  \begin{minipage}[t]{0.45\linewidth}
    \rule{6cm}{0.4pt}\\[-0.2\baselineskip]
    \textit{Konrad Wehkamp}
  \end{minipage}%
}