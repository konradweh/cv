% ============================================================
% PREAMBLE.TEX
% All non-content: packages, fonts, colors, layout, macros
% ============================================================

% -----------------------------
% Language
% -----------------------------
\usepackage[german]{babel}

% -----------------------------
% Page Layout / Graphics
% -----------------------------
\usepackage[a4paper,top=18mm,bottom=18mm,left=18mm,right=18mm]{geometry}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{paracol}
\usepackage{eso-pic}
\usepackage{calc}
\usepackage{array}
\usepackage{tabularx}

% -----------------------------
% Colors
% -----------------------------
\usepackage{xcolor}
\definecolor{cvlightblue}{HTML}{D6DCE4}
\definecolor{cvblue}{HTML}{AEB7C4}
\colorlet{cvgray}{black!65}
\colorlet{cvlightgray}{black!20}
\definecolor{cvblack}{HTML}{000000}

% -----------------------------
% Fonts (XeLaTeX / LuaLaTeX)
% -----------------------------
\usepackage{fontspec}
\defaultfontfeatures{Ligatures=TeX}

% Body font
\setmainfont{Calibri}
\setsansfont{Calibri}

% Headline font
\newfontfamily\CalibriLight{Calibri Light}

% -----------------------------
% Typography helpers
% -----------------------------
\usepackage{microtype}
\usepackage{lipsum}

% ============================================================
% Layout dimensions
% ============================================================

% Header-height
\newlength{\HeaderH}  \setlength{\HeaderH}{60mm}

% Photo dimensions
\newlength{\PhotoW}   \setlength{\PhotoW}{35mm}
\newlength{\PhotoH}   \setlength{\PhotoH}{45mm}
\newlength{\PhotoTopOffset}
\setlength{\PhotoTopOffset}{25mm}

% Column separation
\newlength{\ColSep}   \setlength{\ColSep}{12mm}
\newcommand{\LeftColRatio}{0.35} % <-- Adjust column ratio here

\newlength{\ContentW}
\newlength{\LeftColW}
\newlength{\RightColX}

\setlength{\ContentW}{\textwidth}
\addtolength{\ContentW}{-\ColSep}

\setlength{\LeftColW}{\LeftColRatio\ContentW}
\setlength{\RightColX}{\LeftColW}
\addtolength{\RightColX}{\ColSep}

% x-position of column separation line
\newlength{\SepLineX}
\setlength{\SepLineX}{\LeftColW}
\addtolength{\SepLineX}{0.5\ColSep}


\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt}

% ============================================================
% Macros
% ============================================================

\newcommand{\cvsection}[1]{%
  \par
  {\CalibriLight
   \fontsize{11}{14}\selectfont
   \color{cvblack}
   \addfontfeatures{LetterSpace=25}
   \spaceskip=1em
   \MakeUppercase{#1}
   \par}%
   \vspace{1pt}
}

\newcommand{\cvfirstname}[1]{%
  {\CalibriLight
   \fontsize{27}{32}\selectfont
   \color{cvgray}
   \addfontfeatures{LetterSpace=25}%
   \spaceskip=1em
   \MakeUppercase{#1}}%
}

\newcommand{\cvlastname}[1]{%
  {\CalibriLight
   \fontsize{27}{32}\selectfont
   \color{cvblack}
   \addfontfeatures{LetterSpace=25}%
   \spaceskip=1em
   \MakeUppercase{#1}}%
}

\newcommand{\cvcv}[1]{%
  {\CalibriLight
   \fontsize{20}{24}\selectfont
   \color{cvgray}
   \addfontfeatures{LetterSpace=25}%
   \spaceskip=1em
   \MakeUppercase{#1}}%
}

% ============================================================
% Language skill bars
% ============================================================

% Styling knobs (easy to tweak)
\newlength{\LangBarDashW}   \setlength{\LangBarDashW}{7mm}   % width of one dash
\newlength{\LangBarDashH}   \setlength{\LangBarDashH}{0.8mm} % height of dash
\newlength{\LangBarGap}     \setlength{\LangBarGap}{2mm}     % gap between dashes
\newlength{\LangBarTotalW}                                   % total width of all dashes + gaps

\newlength{\LangGapTop}     \setlength{\LangGapTop}{8pt}   % space: title -> bar
\newlength{\LangGapBot}     \setlength{\LangGapBot}{8pt}   % space: bar -> description

\colorlet{cvbaron}{cvblue}        % "filled" color
\colorlet{cvbaroff}{cvlightgray}  % "empty" color

% Draw N dashes, first K are "on"
\newcommand{\cvlangbar}[2]{%
  \begin{tikzpicture}[baseline=(current bounding box.south)]
    \foreach \i in {1,...,#2} {%
      \pgfmathsetlengthmacro{\x}{(\i-1)*(\LangBarDashW+\LangBarGap)}%
      \ifnum\i>#1
        \fill[cvbaroff] (\x,0) rectangle ++(\LangBarDashW,\LangBarDashH);
      \else
        \fill[cvbaron]  (\x,0) rectangle ++(\LangBarDashW,\LangBarDashH);
      \fi
    }%
  \end{tikzpicture}%
}

% One language entry: name + level row, bar row, description row
% #1 Language label (e.g. Deutsch:)
% #2 Level (e.g. C2)
% #3 filled dashes (e.g. 5)
% #4 total dashes (e.g. 6)
% #5 description (e.g. Muttersprache)
\newcommand{\cvlanguage}[5]{%
  \par\addvspace{10pt}% space between language entries

  \begingroup
    \setlength{\parskip}{0pt}%

    % total width = total*dash + (total-1)*gap
    \setlength{\LangBarTotalW}{%
      \dimexpr #4\LangBarDashW + \numexpr#4-1\relax\LangBarGap \relax
    }%

    \noindent
    \vbox{\offinterlineskip
      % line 1
      \hbox to \LangBarTotalW{\textbf{#1}\hfil \textbf{#2}}%
      \kern\LangGapTop

      % bar
      \hbox{\cvlangbar{#3}{#4}}%
      \kern\LangGapBot

      % line 3
      \hbox to \LangBarTotalW{#5\hfil}%
    }%
  \endgroup
  \par
}

% ============================================================
% CV entry with a right-aligned date, vertically centered
% ============================================================

\newlength{\CVDateW}
\setlength{\CVDateW}{35mm} % <-- width reserved for the date column (adjust)

\newsavebox{\CVLeftBox}
\newlength{\CVLeftW}
\newlength{\CVLeftHT}

\newcommand{\cventry}[2]{%
  \par\addvspace{2pt}

  \begingroup
    \setlength{\parskip}{0pt}

    % Left width = full line minus date column
    \setlength{\CVLeftW}{\dimexpr\linewidth-\CVDateW\relax}

    % Typeset left block into a measuring box
    \sbox{\CVLeftBox}{%
      \begin{minipage}[t]{\CVLeftW}
        #1%
      \end{minipage}%
    }%

    % Measure total height of left block
    \setlength{\CVLeftHT}{\dimexpr\ht\CVLeftBox+\dp\CVLeftBox\relax}

    % Output row
    \noindent
    \usebox{\CVLeftBox}%
    \hfill
    \begin{minipage}[c][\CVLeftHT][c]{\CVDateW}
      \raggedleft{\color{cvlightblue}\small #2}%
    \end{minipage}%
  \endgroup
}

% ============================================================
% Header background + photo
% ============================================================

\AddToShipoutPictureBG{%
\begin{tikzpicture}[remember picture,overlay]

\fill[cvlightblue]
  (current page.north west) rectangle
  ([yshift=-\HeaderH]current page.north east);

\coordinate (PhotoNW) at ([xshift=18mm,yshift=-\PhotoTopOffset]current page.north west);
\node[anchor=north west, fill=white, inner sep=0pt] at (PhotoNW)
{\begin{minipage}[t][\PhotoH][c]{\PhotoW}
\centering
\includegraphics[width=\PhotoW,height=\PhotoH,keepaspectratio]{portrait.JPG}
\end{minipage}};

% vertical separation line
\draw[cvblue, line width=1.0pt]
  ([xshift=18mm+\SepLineX, yshift=-\HeaderH]current page.north west) --
  ([xshift=18mm+\SepLineX, yshift=18mm]current page.south west);

\end{tikzpicture}}

% --- Horizontal section separator (blue stripe) ---
% Draws a line across the full column width (from the middle divider to the outer edge)
\newcommand{\cvhstripe}{%
  \par\vspace{10pt}%
  \noindent{\color{cvblue}\rule{\linewidth}{0.8pt}}%
  \par\vspace{10pt}%
}

% ============================================================
% Body start offset
% ============================================================

\newlength{\BodyStart}
\setlength{\BodyStart}{\HeaderH}
\addtolength{\BodyStart}{-7mm}

% ============================================================
% Header text placement helper
% ============================================================

\newcommand{\PlaceHeaderText}[3]{%
  \smash{%
    \begin{tikzpicture}[remember picture,overlay]
      \node[anchor=north west, align=left] at
      ([xshift=18mm+\RightColX,yshift=-18mm-6mm]current page.north west)
      {%
        \cvfirstname{#1}\hspace{1.5em}\cvlastname{#2}\\[10pt]
        \cvcv{#3}%
      };
    \end{tikzpicture}%
  }%
  \par\nointerlineskip
}